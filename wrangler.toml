name = "nw-london-ml-edge"
main = "src/workers/ml-edge-inference.ts"
compatibility_date = "2024-01-01"
node_compat = true

[vars]
ENVIRONMENT = "production"

[build]
command = "npm run build:edge"

[[kv_namespaces]]
binding = "MODELS"
id = "ml_models_kv"
preview_id = "ml_models_preview"

[[kv_namespaces]]
binding = "CACHE"
id = "ml_cache_kv"
preview_id = "ml_cache_preview"

[[r2_buckets]]
binding = "MODEL_STORAGE"
bucket_name = "ml-models"

[triggers]
crons = ["0 */6 * * *"]  # Run cache warming every 6 hours

[placement]
mode = "smart"

[limits]
cpu_ms = 50

[[routes]]
pattern = "ml-edge.nw-london-ledger.com/*"
zone_name = "nw-london-ledger.com"

[env.production]
vars = { ENVIRONMENT = "production" }
routes = [
  { pattern = "ml-edge.nw-london-ledger.com/*", zone_name = "nw-london-ledger.com" }
]

[env.staging]
name = "nw-london-ml-edge-staging"
vars = { ENVIRONMENT = "staging" }
routes = [
  { pattern = "ml-edge-staging.nw-london-ledger.com/*", zone_name = "nw-london-ledger.com" }
]